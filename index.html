<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CAREKA HUB v5 - Dashboard CRM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; }
    
    /* PALETA CAREKA - Cores únicas */
    :root {
      --careka-primary: #0F766E;
      --careka-primary-light: #2DD4BF;
      --careka-dark: #0B1220;
      --careka-light: #F7F7F5;
    }
    
    body.dark-mode { background: var(--careka-dark); color: #E5E7EB; }
    body.light-mode { background: var(--careka-light); color: #1F2937; }
    
    .card {
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    body.light-mode .card {
      background: #FFFFFF;
      color: #1F2937;
    }
    
    body.dark-mode .card {
      background: #0F172A;
      color: #E5E7EB;
    }
    
    body.light-mode input, body.light-mode select, body.light-mode textarea {
      background: #FFFFFF;
      color: #1F2937;
      border: 1px solid #D1D5DB;
    }
    
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #1E293B;
      color: #E5E7EB;
      border: 1px solid #475569;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--careka-primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    .sidebar {
      background: var(--careka-dark);
      color: white;
      width: 220px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .sidebar h1 {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .sidebar-menu li {
      padding: 12px 16px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
      border-radius: 4px;
    }
    
    .sidebar-menu li:hover {
      background: rgba(45, 212, 191, 0.1);
      border-left-color: var(--careka-primary-light);
    }
    
    .sidebar-menu li.active {
      background: rgba(45, 212, 191, 0.2);
      border-left-color: var(--careka-primary-light);
      color: var(--careka-primary-light);
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .topbar {
      border-bottom: 1px solid #D1D5DB;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    
    body.dark-mode .topbar {
      border-bottom-color: #334155;
    }
    
    .topbar h2 {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: var(--careka-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #065A52;
    }
    
    .btn-blue {
      background: var(--careka-primary);
      color: white;
    }
    
    .btn-blue:hover {
      background: #065A52;
    }
    
    .btn-green {
      background: var(--careka-primary);
      color: white;
    }
    
    .btn-green:hover {
      background: #065A52;
    }
    
    .btn-red {
      background: #DC2626;
      color: white;
    }
    
    .btn-red:hover {
      background: #B91C1C;
    }
    
    .btn-gray {
      background: #6B7280;
      color: white;
    }
    
    .btn-gray:hover {
      background: #4B5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .kpi-box {
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid var(--careka-primary);
    }
    
    .kpi-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }
    
    .kpi-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--careka-primary);
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    
    .kanban {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 16px;
    }
    
    .kanban-col {
      min-width: 320px;
      max-width: 350px;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      border-left: 4px solid var(--careka-primary);
    }
    
    .kanban-col-header {
      font-weight: bold;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kanban-col-count {
      background: var(--careka-primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .kanban-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 100px;
    }
    
    .lead-card {
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      padding: 12px;
      user-select: none;
      border-left: 3px solid var(--careka-primary);
    }
    
    body.light-mode .lead-card {
      background: #FFFFFF;
      border: 1px solid #E5E7EB;
    }
    
    body.dark-mode .lead-card {
      background: #1E293B;
      border: 1px solid #334155;
    }
    
    body.light-mode .lead-card:hover {
      background: #F3F4F6;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.15);
    }
    
    body.dark-mode .lead-card:hover {
      background: #111827;
      box-shadow: 0 4px 12px rgba(45, 212, 191, 0.2);
    }
    
    .lead-card-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .lead-card-company {
      font-size: 12px;
      opacity: 0.6;
      margin-bottom: 8px;
    }
    
    .lead-card-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 4px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-alta {
      background: #FEE2E2;
      color: #7F1D1D;
    }
    
    body.dark-mode .badge-alta {
      background: #7F1D1D;
      color: #FECACA;
    }
    
    .badge-media {
      background: rgba(15, 118, 110, 0.15);
      color: var(--careka-primary);
    }
    
    body.dark-mode .badge-media {
      background: rgba(45, 212, 191, 0.2);
      color: var(--careka-primary-light);
    }
    
    .badge-baixa {
      background: #DCFCE7;
      color: #166534;
    }
    
    body.dark-mode .badge-baixa {
      background: #166534;
      color: #BBF7D0;
    }
    
    .lead-card-value {
      font-weight: bold;
      color: var(--careka-primary);
    }
    
    dialog {
      border: none;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }
    
    body.light-mode dialog {
      background: #FFFFFF;
      color: #1F2937;
    }
    
    body.dark-mode dialog {
      background: #0F172A;
      color: #E5E7EB;
    }
    
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 2px solid var(--careka-primary);
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-content {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #E5E7EB;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    
    body.dark-mode .modal-footer {
      border-top-color: #334155;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .form-group label {
      font-size: 12px;
      font-weight: 500;
      color: var(--careka-primary);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #D1D5DB;
      font-family: inherit;
      font-size: 14px;
    }
    
    .trello-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 100%;
      max-width: 500px;
      height: 100vh;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }
    
    .trello-panel.hidden {
      display: none;
    }
    
    body.light-mode .trello-panel {
      background: #FFFFFF;
      color: #1F2937;
    }
    
    body.dark-mode .trello-panel {
      background: #0F172A;
      color: #E5E7EB;
    }
    
    .trello-header {
      padding: 20px;
      border-bottom: 2px solid var(--careka-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .trello-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .trello-footer {
      padding: 20px;
      border-top: 1px solid #E5E7EB;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    body.dark-mode .trello-footer {
      border-top-color: #334155;
    }
    
    .section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #E5E7EB;
    }
    
    body.dark-mode .section {
      border-bottom-color: #334155;
    }
    
    .section-title {
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--careka-primary);
    }
    
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    
    .backdrop.hidden {
      display: none;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      z-index: 2000;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .toast-success {
      background: var(--careka-primary);
    }
    
    .toast-error {
      background: #EF4444;
    }
    
    .hidden {
      display: none !important;
    }
    
    .page-content.hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 100;
      }
      
      .main-content {
        margin-left: 220px;
      }
      
      .trello-panel {
        max-width: 100%;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="light-mode flex">
  <aside class="sidebar">
    <h1>CAREKA HUB</h1>
    <ul class="sidebar-menu">
      <li class="active" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</li>
      <li data-page="crm"><i class="fas fa-users"></i> CRM</li>
      <li data-page="relatorios"><i class="fas fa-file-csv"></i> Relatórios</li>
    </ul>
    <div style="font-size: 12px; opacity: 0.6;">v5.0 © 2025</div>
  </aside>

  <div class="main-content">
    <div class="topbar">
      <h2 id="page-title">Dashboard</h2>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-primary" id="btn-novo"><i class="fas fa-plus"></i> Novo</button>
        <button class="btn btn-primary" id="btn-importar"><i class="fas fa-upload"></i> Importar</button>
        <button class="btn btn-primary" id="btn-modelo-csv"><i class="fas fa-download"></i> CSV</button>
        <button class="btn btn-primary" id="btn-modelo-xlsx"><i class="fas fa-download"></i> XLSX</button>
        <button class="btn btn-red" id="btn-reset"><i class="fas fa-redo"></i> Reset</button>
        <button class="btn btn-gray" id="btn-theme"><i class="fas fa-moon"></i> Tema</button>
      </div>
    </div>

    <div class="content-area">
      <div id="page-dashboard" class="page-content">
        <div class="kpi-grid">
          <div class="card kpi-box">
            <div class="kpi-label">Total Leads</div>
            <div class="kpi-value" id="kpi-leads">0</div>
          </div>
          <div class="card kpi-box">
            <div class="kpi-label">Conversados</div>
            <div class="kpi-value" id="kpi-conv">0</div>
          </div>
          <div class="card kpi-box">
            <div class="kpi-label">Novos</div>
            <div class="kpi-value" id="kpi-novos">0</div>
          </div>
          <div class="card kpi-box">
            <div class="kpi-label">Taxa Conv.</div>
            <div class="kpi-value" id="kpi-taxa">0%</div>
          </div>
          <div class="card kpi-box">
            <div class="kpi-label">Pipeline</div>
            <div class="kpi-value" id="kpi-pipe">R$ 0</div>
          </div>
          <div class="card kpi-box">
            <div class="kpi-label">Score Médio</div>
            <div class="kpi-value" id="kpi-score">0</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Leads por Período</h3>
            <div class="chart-container"><canvas id="chart-periodo"></canvas></div>
          </div>
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Origem dos Leads</h3>
            <div class="chart-container"><canvas id="chart-origem"></canvas></div>
          </div>
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Conversão por Estágio</h3>
            <div class="chart-container"><canvas id="chart-estagio"></canvas></div>
          </div>
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Score Distribuição</h3>
            <div class="chart-container"><canvas id="chart-score"></canvas></div>
          </div>
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Pipeline por Estágio</h3>
            <div class="chart-container"><canvas id="chart-pipeline"></canvas></div>
          </div>
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-weight: bold; color: var(--careka-primary);">Propostas</h3>
            <div class="chart-container"><canvas id="chart-propostas"></canvas></div>
          </div>
        </div>
      </div>

      <div id="page-crm" class="page-content hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="margin: 0; font-weight: bold; font-size: 18px;">Kanban - Funis de Vendas</h3>
          <button class="btn btn-primary" id="btn-novo-stage"><i class="fas fa-plus"></i> Novo Estágio</button>
        </div>
        <div class="kanban" id="kanban"></div>
      </div>

      <div id="page-relatorios" class="page-content hidden">
        <div class="card" style="padding: 24px;">
          <h3 style="margin: 0 0 16px 0; font-weight: bold; font-size: 18px;">Exportação de Dados</h3>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" id="btn-export-csv"><i class="fas fa-file-csv"></i> CSV</button>
            <button class="btn btn-primary" id="btn-export-xlsx"><i class="fas fa-file-excel"></i> XLSX</button>
            <button class="btn btn-primary" id="btn-export-json"><i class="fas fa-file-json"></i> JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="backdrop" class="backdrop hidden"></div>

  <dialog id="modal-novo">
    <div class="modal-header">
      Novo Lead
      <button onclick="document.getElementById('modal-novo').close()" style="border: none; background: none; cursor: pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
    </div>
    <form id="form-novo" class="modal-content">
      <div class="form-grid">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" name="nome" placeholder="Nome" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" placeholder="Email">
        </div>
        <div class="form-group">
          <label>Telefone</label>
          <input type="tel" name="telefone" placeholder="Telefone">
        </div>
        <div class="form-group">
          <label>Empresa</label>
          <input type="text" name="empresa" placeholder="Empresa">
        </div>
        <div class="form-group">
          <label>Cargo</label>
          <input type="text" name="cargo" placeholder="Cargo">
        </div>
        <div class="form-group">
          <label>Segmento</label>
          <input type="text" name="segmento" placeholder="Segmento">
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" placeholder="0" min="0" step="100">
        </div>
        <div class="form-group">
          <label>Score</label>
          <input type="number" name="score" placeholder="50" value="50" min="0" max="100">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Origem</label>
          <select name="origem">
            <option value="Google">Google</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="Indicação">Indicação</option>
            <option value="Instagram">Instagram</option>
            <option value="Facebook">Facebook</option>
            <option value="Tráfego Pago">Tráfego Pago</option>
            <option value="Site">Site</option>
            <option value="WhatsApp">WhatsApp</option>
            <option value="Direto">Direto</option>
            <option value="YouTube">YouTube</option>
            <option value="Evento">Evento</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Canal</label>
          <select name="canal">
            <option value="Email">Email</option>
            <option value="WhatsApp">WhatsApp</option>
            <option value="Ligação">Ligação</option>
            <option value="Encontro">Encontro</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Estágio</label>
          <select id="form-novo-estagio" name="estagio">
            <!-- Preenchido dinamicamente -->
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Prioridade</label>
          <select name="prioridade">
            <option value="Baixa">Baixa</option>
            <option value="Média">Média</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
      </div>
    </form>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" onclick="submitFormNovo()">Salvar</button>
      <button type="button" class="btn btn-gray" onclick="document.getElementById('modal-novo').close()">Cancelar</button>
    </div>
  </dialog>

  <dialog id="modal-novo-stage">
    <div class="modal-header">
      Novo Estágio
      <button onclick="document.getElementById('modal-novo-stage').close()" style="border: none; background: none; cursor: pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-content">
      <div class="form-group" style="margin-bottom: 16px;">
        <label>Nome do Estágio *</label>
        <input type="text" id="input-stage-nome" placeholder="Ex: Nutrir, Futuro, Ajuste">
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" onclick="addNovoStage()">Criar</button>
      <button type="button" class="btn btn-gray" onclick="document.getElementById('modal-novo-stage').close()">Cancelar</button>
    </div>
  </dialog>

  <dialog id="modal-reset">
    <div class="modal-header">
      <span style="color: #DC2626;">RESETAR BASE DE DADOS</span>
      <button onclick="document.getElementById('modal-reset').close()" style="border: none; background: none; cursor: pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-content">
      <p style="margin: 0 0 16px 0;">Digite <strong>RESET</strong> para confirmar a exclusão de TODOS os leads:</p>
      <input type="text" id="input-reset" placeholder="Digite RESET aqui" maxlength="5" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px;">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-red" id="btn-confirmar-reset" disabled>Confirmar Exclusão</button>
      <button type="button" class="btn btn-gray" onclick="document.getElementById('modal-reset').close()">Cancelar</button>
    </div>
  </dialog>

  <dialog id="modal-importar">
    <div class="modal-header">
      Importar Arquivo
      <button onclick="document.getElementById('modal-importar').close()" style="border: none; background: none; cursor: pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-content">
      <div id="drop-zone" style="border: 2px dashed var(--careka-primary); border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s;">
        <p style="margin: 0; font-size: 14px;">Arraste arquivos CSV ou XLSX aqui ou clique para selecionar</p>
        <input type="file" id="input-import" accept=".csv,.xlsx,.xls" style="display: none;">
      </div>
      <div id="import-preview" style="margin-top: 16px; padding: 12px; border-radius: 6px; font-size: 14px; display: none;"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" id="btn-processar-import" style="display: none;">Processar</button>
      <button type="button" class="btn btn-gray" onclick="document.getElementById('modal-importar').close()">Fechar</button>
    </div>
  </dialog>

  <div id="trello-backdrop" class="backdrop hidden" onclick="closeTrello()"></div>
  <div id="trello-panel" class="trello-panel hidden">
    <div class="trello-header">
      <h2 id="trello-title" style="margin: 0; font-size: 18px;"></h2>
      <button onclick="closeTrello()" style="border: none; background: none; cursor: pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="trello-body">
      <div class="section">
        <div class="section-title">Informações</div>
        <div class="form-grid">
          <div class="form-group" style="grid-column: 1 / -1;">
            <input type="text" id="trello-nome" placeholder="Nome do Lead">
          </div>
          <div class="form-group">
            <label>Estágio</label>
            <select id="trello-estagio">
              <!-- Preenchido dinamicamente -->
            </select>
          </div>
          <div class="form-group">
            <label>Prioridade</label>
            <select id="trello-prioridade">
              <option value="Baixa">Baixa</option>
              <option value="Média">Média</option>
              <option value="Alta">Alta</option>
            </select>
          </div>
          <div class="form-group">
            <label>Empresa</label>
            <input type="text" id="trello-empresa" placeholder="Empresa">
          </div>
          <div class="form-group">
            <label>Cargo</label>
            <input type="text" id="trello-cargo" placeholder="Cargo">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="trello-email" placeholder="Email">
          </div>
          <div class="form-group">
            <label>Telefone</label>
            <input type="tel" id="trello-telefone" placeholder="Telefone">
          </div>
          <div class="form-group">
            <label>Segmento</label>
            <input type="text" id="trello-segmento" placeholder="Segmento">
          </div>
          <div class="form-group">
            <label>Valor (R$)</label>
            <input type="number" id="trello-valor" placeholder="0" min="0" step="100">
          </div>
          <div class="form-group">
            <label>Score</label>
            <input type="number" id="trello-score" placeholder="50" min="0" max="100">
          </div>
          <div class="form-group">
            <label>Origem</label>
            <select id="trello-origem">
              <option value="Google">Google</option>
              <option value="LinkedIn">LinkedIn</option>
              <option value="Indicação">Indicação</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="Tráfego Pago">Tráfego Pago</option>
              <option value="Site">Site</option>
              <option value="WhatsApp">WhatsApp</option>
              <option value="Direto">Direto</option>
              <option value="YouTube">YouTube</option>
              <option value="Evento">Evento</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Canal</label>
            <select id="trello-canal">
              <option value="Email">Email</option>
              <option value="WhatsApp">WhatsApp</option>
              <option value="Ligação">Ligação</option>
              <option value="Encontro">Encontro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Descrição</div>
        <textarea id="trello-descricao" placeholder="Adicione uma descrição..." style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px;"></textarea>
      </div>

      <div class="section">
        <div class="section-title">Atividades</div>
        <div id="trello-atividades" style="margin-bottom: 12px; max-height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.03); padding: 8px; border-radius: 4px; font-size: 12px;"></div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="trello-nova-atividade" placeholder="Nova nota..." style="flex: 1;">
          <button type="button" onclick="addAtividade()" class="btn btn-primary">+</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Checklist</div>
        <div id="trello-checklist" style="margin-bottom: 12px; max-height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.03); padding: 8px; border-radius: 4px; font-size: 12px;"></div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="trello-novo-item" placeholder="Novo item..." style="flex: 1;">
          <button type="button" onclick="addItemChecklist()" class="btn btn-primary">+</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Próximo Contato</div>
        <input type="datetime-local" id="trello-proximo" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px;">
      </div>

      <div class="section">
        <div class="section-title">Anexos</div>
        <div id="trello-anexos" style="margin-bottom: 12px; max-height: 100px; overflow-y: auto; background: rgba(0, 0, 0, 0.03); padding: 8px; border-radius: 4px; font-size: 12px;"></div>
        <div style="display: flex; gap: 8px;">
          <input type="url" id="trello-nova-url" placeholder="URL..." style="flex: 1;">
          <button type="button" onclick="addAnexo()" class="btn btn-primary">+</button>
        </div>
      </div>

      <div class="section" style="border-bottom: none;">
        <div class="section-title">Histórico</div>
        <div id="trello-historico" style="max-height: 100px; overflow-y: auto; background: rgba(0, 0, 0, 0.03); padding: 8px; border-radius: 4px; font-size: 11px;"></div>
      </div>
    </div>
    <div class="trello-footer">
      <button type="button" onclick="saveTrello()" class="btn btn-primary" style="flex: 1;">Salvar</button>
      <button type="button" onclick="duplicarLead()" class="btn btn-primary" style="flex: 1;">Duplicar</button>
      <button type="button" onclick="confirmDeleteLead()" class="btn btn-red" style="flex: 1;">Excluir</button>
    </div>
  </div>

  <script>
    const STATE_KEY = 'careka-hub-v5';
    const DEFAULT_ETAPAS = ['Novo', 'Qualificar', 'Diagnóstico', 'Proposta', 'Ganho', 'Perdido'];
    const ORIGENS_CORES = {
      'Google': '#EA4335',
      'LinkedIn': '#0A66C2',
      'Indicação': '#F59E0B',
      'Instagram': '#E1306C',
      'Facebook': '#1877F2',
      'Tráfego Pago': '#6366F1',
      'Site': '#3B82F6',
      'WhatsApp': '#25D366',
      'Direto': '#0F766E',
      'YouTube': '#FF0000',
      'Evento': '#8B5CF6',
      'Outro': '#6B7280'
    };

    let state = { leads: [], tarefas: [], eventos: [], propostas: [], interacoes: [], etapas: DEFAULT_ETAPAS.slice() };
    let charts = {};
    let currentLeadId = null;
    let importData = null;

    function uuid() { return 'l_' + Math.random().toString(36).substr(2, 9) + Date.now(); }
    function nowISO() { return new Date().toISOString(); }
    function toReal(v) { return 'R$ ' + Number(v || 0).toLocaleString('pt-BR'); }
    function formatData(d) { return new Date(d).toLocaleDateString('pt-BR'); }
    function el(id) { return document.getElementById(id); }

    function loadState() {
      try {
        const saved = localStorage.getItem(STATE_KEY);
        return saved ? JSON.parse(saved) : null;
      } catch (e) {
        console.error('Erro ao carregar estado:', e);
        return null;
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
        console.log('Estado salvo:', state.leads.length + ' leads');
      } catch (e) {
        console.error('Erro ao salvar estado:', e);
      }
    }

    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast ' + (type === 'success' ? 'toast-success' : 'toast-error');
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function normalizeColName(col) {
      const lower = col.toLowerCase().trim();
      const map = {
        'nome': 'nome', 'name': 'nome',
        'email': 'email',
        'telefone': 'telefone', 'phone': 'telefone',
        'empresa': 'empresa', 'company': 'empresa',
        'cargo': 'cargo', 'role': 'cargo', 'position': 'cargo',
        'segmento': 'segmento', 'segment': 'segmento',
        'valor': 'valor', 'amount': 'valor', 'deal_value': 'valor',
        'origem': 'origem', 'source': 'origem',
        'canal': 'canal', 'channel': 'canal',
        'score': 'score',
        'prioridade': 'prioridade', 'priority': 'prioridade',
        'estagio': 'estagio', 'stage': 'estagio',
        'observacoes': 'observacoes', 'notes': 'observacoes'
      };
      return map[lower] || null;
    }

    function initializeState() {
      const saved = loadState();
      if (saved && saved.leads && saved.leads.length > 0) {
        state = saved;
        if (!state.etapas) state.etapas = DEFAULT_ETAPAS.slice();
        console.log('Estado carregado:', state.leads.length + ' leads, etapas:', state.etapas);
      } else {
        state = {
          leads: [
            {id: uuid(), nome: 'Dr. Martinez', empresa: 'Clínica Sorriso', cargo: 'Diretor', email: 'martinez@clinic.com', telefone: '11 99999-0001', segmento: 'Odontologia', valor: 15000, score: 78, origem: 'LinkedIn', canal: 'Email', prioridade: 'Alta', estagio: 'Novo', observacoes: '', descricao: 'Cliente potencial', atividades: [], checklist: [{id: uuid(), texto: 'Enviar proposta', feito: false}], anexos: [], dataCriacao: nowISO(), ultimoContato: nowISO(), proximoContato: '', historico: []},
            {id: uuid(), nome: 'Ana Silva', empresa: 'Academia FitMax', cargo: 'Gerente', email: 'ana@fitmax.com', telefone: '11 99999-0002', segmento: 'Academia', valor: 8000, score: 61, origem: 'Indicação', canal: 'WhatsApp', prioridade: 'Média', estagio: 'Qualificar', observacoes: '', descricao: '', atividades: [{id: uuid(), texto: 'Primeiro contato', data: nowISO()}], checklist: [], anexos: [], dataCriacao: nowISO(), ultimoContato: nowISO(), proximoContato: '', historico: []},
            {id: uuid(), nome: 'Carlos Oliveira', empresa: 'Studio Slim', cargo: 'Sócio', email: 'carlos@studio.com', telefone: '11 99999-0003', segmento: 'Estética', valor: 12000, score: 73, origem: 'Google', canal: 'Ligação', prioridade: 'Alta', estagio: 'Diagnóstico', observacoes: '', descricao: '', atividades: [], checklist: [{id: uuid(), texto: 'Agende reunião', feito: false}], anexos: [], dataCriacao: nowISO(), ultimoContato: nowISO(), proximoContato: new Date(Date.now() + 3*24*60*60*1000).toISOString(), historico: []},
            {id: uuid(), nome: 'Mariana Costa', empresa: 'Tech Startup', cargo: 'CTO', email: 'mariana@tech.com', telefone: '11 99999-0004', segmento: 'Tecnologia', valor: 25000, score: 85, origem: 'Instagram', canal: 'Email', prioridade: 'Alta', estagio: 'Proposta', observacoes: '', descricao: '', atividades: [], checklist: [], anexos: [], dataCriacao: nowISO(), ultimoContato: nowISO(), proximoContato: '', historico: []},
            {id: uuid(), nome: 'Roberto Santos', empresa: 'Consultoria RH', cargo: 'Diretor', email: 'roberto@consultrh.com', telefone: '11 99999-0005', segmento: 'Consultoria', valor: 18000, score: 72, origem: 'Facebook', canal: 'Email', prioridade: 'Média', estagio: 'Proposta', observacoes: '', descricao: '', atividades: [], checklist: [], anexos: [], dataCriacao: nowISO(), ultimoContato: nowISO(), proximoContato: '', historico: []}
          ],
          tarefas: [],
          eventos: [],
          propostas: [],
          interacoes: [],
          etapas: DEFAULT_ETAPAS.slice()
        };
        saveState();
      }
      updateEtagasSelects();
    }

    function updateEtagasSelects() {
      const selectNovo = el('form-novo-estagio');
      const selectTrello = el('trello-estagio');
      
      selectNovo.innerHTML = state.etapas.map(e => `<option value="${e}">${e}</option>`).join('');
      selectTrello.innerHTML = state.etapas.map(e => `<option value="${e}">${e}</option>`).join('');
    }

    // Sidebar navigation
    document.querySelectorAll('.sidebar-menu li').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.sidebar-menu li').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
        el('page-' + page).classList.remove('hidden');
        el('page-title').textContent = {dashboard: 'Dashboard', crm: 'CRM', relatorios: 'Relatórios'}[page] || 'Dashboard';
        if (page === 'crm') renderCRM();
        else if (page === 'dashboard') renderDashboard();
      });
    });

    // Theme toggle
    el('btn-theme').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-mode');
      document.body.classList.toggle('dark-mode');
      document.body.classList.toggle('light-mode');
      localStorage.setItem('careka-theme-v5', isDark ? 'light' : 'dark');
      updateCharts();
    });

    const savedTheme = localStorage.getItem('careka-theme-v5') || 'light';
    document.body.classList.remove('dark-mode', 'light-mode');
    document.body.classList.add(savedTheme + '-mode');

    // Novo Lead
    el('btn-novo').addEventListener('click', () => el('modal-novo').showModal());
    
    function submitFormNovo() {
      const form = el('form-novo');
      const fd = new FormData(form);
      
      if (!fd.get('nome').trim()) {
        showToast('Nome é obrigatório!', 'error');
        return;
      }
      
      state.leads.push({
        id: uuid(),
        nome: fd.get('nome'),
        email: fd.get('email'),
        telefone: fd.get('telefone'),
        empresa: fd.get('empresa'),
        cargo: fd.get('cargo'),
        segmento: fd.get('segmento'),
        valor: Number(fd.get('valor')) || 0,
        score: Number(fd.get('score')) || 50,
        origem: fd.get('origem'),
        canal: fd.get('canal'),
        prioridade: fd.get('prioridade'),
        estagio: fd.get('estagio') || state.etapas[0],
        observacoes: '',
        descricao: '',
        atividades: [],
        checklist: [],
        anexos: [],
        dataCriacao: nowISO(),
        ultimoContato: nowISO(),
        proximoContato: '',
        historico: []
      });
      
      saveState();
      renderAll();
      el('modal-novo').close();
      form.reset();
      showToast('Lead criado com sucesso!');
    }

    // Novo Estágio
    el('btn-novo-stage').addEventListener('click', () => el('modal-novo-stage').showModal());
    
    function addNovoStage() {
      const nome = el('input-stage-nome').value.trim();
      if (!nome) {
        showToast('Nome do estágio é obrigatório!', 'error');
        return;
      }
      if (state.etapas.includes(nome)) {
        showToast('Este estágio já existe!', 'error');
        return;
      }
      state.etapas.push(nome);
      saveState();
      updateEtagasSelects();
      renderCRM();
      el('modal-novo-stage').close();
      el('input-stage-nome').value = '';
      showToast('Estágio criado com sucesso!');
    }

    // Reset
    el('btn-reset').addEventListener('click', () => {
      el('input-reset').value = '';
      el('btn-confirmar-reset').disabled = true;
      el('modal-reset').showModal();
    });

    el('input-reset').addEventListener('input', (e) => {
      el('btn-confirmar-reset').disabled = e.target.value !== 'RESET';
    });

    el('btn-confirmar-reset').addEventListener('click', () => {
      console.log('Reset confirmado - apagando todos os leads');
      
      state.leads = [];
      state.tarefas = [];
      state.eventos = [];
      state.propostas = [];
      state.interacoes = [];
      
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
      
      el('modal-reset').close();
      el('input-reset').value = '';
      el('btn-confirmar-reset').disabled = true;
      
      renderAll();
      
      console.log('Estado após reset:', state.leads.length + ' leads');
      
      showToast('Base de dados zerada com sucesso!');
    });

    // Import
    el('btn-importar').addEventListener('click', () => {
      importData = null;
      el('import-preview').style.display = 'none';
      el('btn-processar-import').style.display = 'none';
      el('modal-importar').showModal();
    });

    el('drop-zone').addEventListener('click', () => el('input-import').click());
    el('drop-zone').addEventListener('dragover', (e) => { e.preventDefault(); el('drop-zone').style.opacity = '0.7'; });
    el('drop-zone').addEventListener('dragleave', () => { el('drop-zone').style.opacity = '1'; });
    el('drop-zone').addEventListener('drop', (e) => { e.preventDefault(); el('drop-zone').style.opacity = '1'; processImportFile(e.dataTransfer.files[0]); });
    el('input-import').addEventListener('change', (e) => { if (e.target.files.length > 0) processImportFile(e.target.files[0]); });

    function processImportFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          if (file.name.endsWith('.csv')) {
            Papa.parse(evt.target.result, {
              header: true,
              skipEmptyLines: true,
              complete: (res) => previewImport(res.data)
            });
          } else {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            previewImport(jsonData);
          }
        } catch (err) {
          showToast('Erro ao ler arquivo: ' + err.message, 'error');
        }
      };
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    }

    function previewImport(dados) {
      if (!Array.isArray(dados)) dados = [dados];
      let validos = 0, invalidos = [];
      const normalized = [];

      dados.forEach((row, idx) => {
        const newRow = {};
        Object.keys(row).forEach(col => {
          const norm = normalizeColName(col);
          if (norm) newRow[norm] = row[col];
        });
        if ((newRow.nome || newRow.empresa) && newRow.valor) {
          normalized.push(newRow);
          validos++;
        } else {
          invalidos.push(`Linha ${idx + 1}`);
        }
      });

      importData = normalized;
      const preview = `Válidos: ${validos}${invalidos.length > 0 ? ', Inválidos: ' + invalidos.length : ''}`;
      el('import-preview').innerHTML = preview;
      el('import-preview').style.display = 'block';
      el('btn-processar-import').style.display = 'block';
    }

    el('btn-processar-import').addEventListener('click', () => {
      if (!importData || importData.length === 0) {
        showToast('Nenhum dado para importar', 'error');
        return;
      }
      let imported = 0;
      importData.forEach(row => {
        state.leads.push({
          id: uuid(),
          nome: row.nome || '',
          email: row.email || '',
          telefone: row.telefone || '',
          empresa: row.empresa || '',
          cargo: row.cargo || '',
          segmento: row.segmento || '',
          valor: Number(row.valor) || 0,
          score: Number(row.score) || 50,
          origem: row.origem || 'Outro',
          canal: row.canal || 'Email',
          prioridade: row.prioridade || 'Média',
          estagio: row.estagio || state.etapas[0],
          observacoes: row.observacoes || '',
          descricao: '',
          atividades: [],
          checklist: [],
          anexos: [],
          dataCriacao: nowISO(),
          ultimoContato: nowISO(),
          proximoContato: '',
          historico: [{acao: 'importado', data: nowISO()}]
        });
        imported++;
      });
      saveState();
      renderAll();
      el('modal-importar').close();
      showToast(`${imported} leads importados com sucesso!`);
    });

    // Export models
    el('btn-modelo-csv').addEventListener('click', () => {
      const header = 'nome,empresa,cargo,email,telefone,segmento,valor,origem,canal,score,prioridade,estagio';
      const csv = header + '\nExemplo,Empresa Exemplo,Gerente,contato@example.com,11 99999-9999,Tecnologia,10000,Google,Email,75,Alta,Novo';
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'modelo-leads.csv';
      a.click();
    });

    el('btn-modelo-xlsx').addEventListener('click', () => {
      const data = [{nome: 'Exemplo', empresa: 'Empresa Exemplo', cargo: 'Gerente', email: 'contato@example.com', telefone: '11 99999-9999', segmento: 'Tecnologia', valor: 10000, origem: 'Google', canal: 'Email', score: 75, prioridade: 'Alta', estagio: 'Novo'}];
      const sheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, sheet, 'Leads');
      XLSX.write(workbook, {bookType: 'xlsx', type: 'binary', filename: 'modelo-leads.xlsx'});
    });

    // Export data
    el('btn-export-csv').addEventListener('click', () => {
      const header = 'nome,empresa,email,telefone,valor,score,estagio,origem';
      const rows = state.leads.map(l => `"${l.nome}","${l.empresa}","${l.email}","${l.telefone}",${l.valor},${l.score},"${l.estagio}","${l.origem}"`);
      const csv = header + '\n' + rows.join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `leads-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });

    el('btn-export-xlsx').addEventListener('click', () => {
      const data = state.leads.map(l => ({
        Nome: l.nome,
        Empresa: l.empresa,
        Email: l.email,
        Telefone: l.telefone,
        Valor: l.valor,
        Score: l.score,
        'Estágio': l.estagio,
        Origem: l.origem
      }));
      const sheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, sheet, 'Leads');
      XLSX.write(workbook, {bookType: 'xlsx', type: 'binary', filename: `leads-${new Date().toISOString().split('T')[0]}.xlsx`});
    });

    el('btn-export-json').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `careka-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    });

    // KPIs
    function updateKPIs() {
      const semana = new Date(Date.now() - 7*24*60*60*1000);
      el('kpi-leads').textContent = state.leads.length;
      el('kpi-conv').textContent = state.leads.filter(l => new Date(l.ultimoContato) >= semana).length;
      el('kpi-novos').textContent = state.leads.filter(l => new Date(l.dataCriacao) >= semana).length;
      const ganhos = state.leads.filter(l => l.estagio === 'Ganho').length;
      el('kpi-taxa').textContent = state.leads.length ? Math.round((ganhos / state.leads.length) * 100) + '%' : '0%';
      const pipe = state.leads.filter(l => l.estagio !== 'Ganho' && l.estagio !== 'Perdido').reduce((a, b) => a + b.valor, 0);
      el('kpi-pipe').textContent = toReal(pipe);
      const score = state.leads.length ? Math.round(state.leads.reduce((a, b) => a + b.score, 0) / state.leads.length) : 0;
      el('kpi-score').textContent = score;
    }

    function renderDashboard() {
      updateKPIs();
      renderCharts();
    }

    function getChartTheme() {
      const isDark = document.body.classList.contains('dark-mode');
      return {
        text: isDark ? '#E5E7EB' : '#1F2937',
        grid: isDark ? '#334155' : '#E5E7EB'
      };
    }

    function renderCharts() {
      Object.values(charts).forEach(c => c?.destroy?.());
      charts = {};
      const theme = getChartTheme();

      const ctx1 = el('chart-periodo')?.getContext('2d');
      if (ctx1) {
        const agora = new Date();
        const periodos = ['Semana', 'Mês', '3M', '6M', '12M'];
        const dias = [7, 30, 90, 180, 365];
        const dados = dias.map(d => {
          const data = new Date(agora);
          data.setDate(data.getDate() - d);
          return state.leads.filter(l => new Date(l.dataCriacao) >= data).length;
        });
        charts['periodo'] = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: periodos,
            datasets: [{label: 'Novos Leads', data: dados, backgroundColor: '#0F766E'}]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {labels: {color: theme.text}}},
            scales: {
              y: {ticks: {color: theme.text}, grid: {color: theme.grid}},
              x: {ticks: {color: theme.text}, grid: {display: false}}
            }
          }
        });
      }

      const ctx2 = el('chart-origem')?.getContext('2d');
      if (ctx2) {
        const origens = [...new Set(state.leads.map(l => l.origem || 'Outro'))];
        const dados = origens.map(o => state.leads.filter(l => (l.origem || 'Outro') === o).length);
        const cores = origens.map(o => ORIGENS_CORES[o] || '#6B7280');
        charts['origem'] = new Chart(ctx2, {
          type: 'doughnut',
          data: {labels: origens, datasets: [{data: dados, backgroundColor: cores}]},
          options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {labels: {color: theme.text}}}}
        });
      }

      const ctx3 = el('chart-estagio')?.getContext('2d');
      if (ctx3) {
        const dados = state.etapas.map(e => state.leads.filter(l => l.estagio === e).length);
        const cores = state.etapas.map((e, i) => {
          const hues = [0, 45, 90, 135, 180, 225, 270, 315];
          const hue = hues[i % hues.length];
          return `hsl(${hue}, 70%, 50%)`;
        });
        charts['estagio'] = new Chart(ctx3, {
          type: 'bar',
          data: {labels: state.etapas, datasets: [{label: 'Quantidade', data: dados, backgroundColor: cores}]},
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {display: false}},
            scales: {
              x: {ticks: {color: theme.text}, grid: {color: theme.grid}},
              y: {ticks: {color: theme.text}}
            }
          }
        });
      }

      const ctx4 = el('chart-score')?.getContext('2d');
      if (ctx4) {
        const ranges = ['0-20', '21-40', '41-60', '61-80', '81-100'];
        const dados = ranges.map((r, i) => {
          const min = i * 20;
          const max = (i + 1) * 20;
          return state.leads.filter(l => l.score >= min && l.score < max).length;
        });
        charts['score'] = new Chart(ctx4, {
          type: 'line',
          data: {
            labels: ranges,
            datasets: [{
              label: 'Leads',
              data: dados,
              borderColor: '#0F766E',
              backgroundColor: 'rgba(15, 118, 110, 0.1)',
              borderWidth: 2,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {labels: {color: theme.text}}},
            scales: {
              y: {ticks: {color: theme.text}, grid: {color: theme.grid}},
              x: {ticks: {color: theme.text}, grid: {display: false}}
            }
          }
        });
      }

      const ctx5 = el('chart-pipeline')?.getContext('2d');
      if (ctx5) {
        const dados = state.etapas.map(e => state.leads.filter(l => l.estagio === e).reduce((a, b) => a + b.valor, 0));
        const cores = state.etapas.map((e, i) => {
          const hues = [0, 45, 90, 135, 180, 225, 270, 315];
          const hue = hues[i % hues.length];
          return `hsl(${hue}, 70%, 50%)`;
        });
        charts['pipeline'] = new Chart(ctx5, {
          type: 'bar',
          data: {labels: state.etapas, datasets: [{label: 'R$', data: dados, backgroundColor: cores}]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {display: false}},
            scales: {
              y: {ticks: {color: theme.text}, grid: {color: theme.grid}},
              x: {ticks: {color: theme.text}, grid: {display: false}}
            }
          }
        });
      }

      const ctx6 = el('chart-propostas')?.getContext('2d');
      if (ctx6) {
        const dados = [
          state.leads.filter(l => l.estagio === 'Proposta').length,
          state.leads.filter(l => l.estagio === 'Ganho').length
        ];
        charts['propostas'] = new Chart(ctx6, {
          type: 'doughnut',
          data: {
            labels: ['Enviadas', 'Ganhas'],
            datasets: [{data: dados, backgroundColor: ['#F59E0B', '#10B981']}]
          },
          options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {labels: {color: theme.text}}}}
        });
      }
    }

    function updateCharts() {
      renderCharts();
    }

    function renderCRM() {
      const kanban = el('kanban');
      kanban.innerHTML = '';
      
      console.log('Renderizando Kanban com', state.leads.length, 'leads, etapas:', state.etapas);
      
      state.etapas.forEach((etapa, idx) => {
        const leads = state.leads.filter(l => l.estagio === etapa);
        const col = document.createElement('div');
        col.className = 'kanban-col card';
        
        const hues = [0, 45, 90, 135, 180, 225, 270, 315];
        const hue = hues[idx % hues.length];
        const bgColor = `hsl(${hue}, 20%, 95%)`;
        col.style.backgroundColor = bgColor;

        const header = document.createElement('div');
        header.className = 'kanban-col-header';
        header.innerHTML = `<span>${etapa}</span><div class="kanban-col-count">${leads.length}</div>`;
        col.appendChild(header);

        const list = document.createElement('div');
        list.className = 'kanban-list';
        list.id = `col-${etapa}`;
        
        leads.forEach(lead => {
          const card = document.createElement('div');
          card.className = 'lead-card';
          card.draggable = true;
          card.dataset.id = lead.id;

          card.innerHTML = `
            <div class="lead-card-title">${lead.nome}</div>
            <div class="lead-card-company">${lead.empresa}</div>
            <div class="lead-card-bottom">
              <span class="badge badge-${lead.prioridade.toLowerCase()}">${lead.prioridade}</span>
              <span>S${lead.score}</span>
            </div>
            <div class="lead-card-value">${toReal(lead.valor)}</div>
          `;

          card.addEventListener('click', () => openTrello(lead.id));
          card.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('leadId', lead.id);
          });

          list.appendChild(card);
        });

        list.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        list.addEventListener('drop', (e) => {
          e.preventDefault();
          const leadId = e.dataTransfer.getData('leadId');
          const lead = state.leads.find(l => l.id === leadId);
          if (lead) {
            const oldStage = lead.estagio;
            lead.estagio = etapa;
            lead.ultimoContato = nowISO();
            if (!lead.historico) lead.historico = [];
            lead.historico.push({acao: `movido de ${oldStage} para ${etapa}`, data: nowISO()});
            saveState();
            renderCRM();
            updateKPIs();
            updateCharts();
          }
        });

        col.appendChild(list);
        kanban.appendChild(col);
      });
    }

    function openTrello(leadId) {
      currentLeadId = leadId;
      const lead = state.leads.find(l => l.id === leadId);
      if (!lead) return;

      el('trello-nome').value = lead.nome;
      el('trello-estagio').value = lead.estagio;
      el('trello-prioridade').value = lead.prioridade;
      el('trello-empresa').value = lead.empresa;
      el('trello-cargo').value = lead.cargo || '';
      el('trello-email').value = lead.email;
      el('trello-telefone').value = lead.telefone;
      el('trello-segmento').value = lead.segmento;
      el('trello-valor').value = lead.valor;
      el('trello-score').value = lead.score;
      el('trello-origem').value = lead.origem;
      el('trello-canal').value = lead.canal;
      el('trello-descricao').value = lead.descricao || '';
      el('trello-proximo').value = lead.proximoContato ? lead.proximoContato.slice(0, 16) : '';

      el('trello-atividades').innerHTML = (lead.atividades || []).map(a => `<div style="margin-bottom: 8px;"><strong>${formatData(a.data)}</strong>: ${a.texto}</div>`).join('') || 'Nenhuma atividade';
      el('trello-checklist').innerHTML = (lead.checklist || []).map(item => `<div style="margin-bottom: 6px;"><input type="checkbox" ${item.feito ? 'checked' : ''} onchange="updateChecklistItem('${lead.id}', '${item.id}', this.checked)"><span style="margin-left: 4px; ${item.feito ? 'text-decoration: line-through;' : ''}">${item.texto}</span></div>`).join('') || 'Nenhum item';
      el('trello-anexos').innerHTML = (lead.anexos || []).map(a => `<div><a href="${a.url}" target="_blank" style="color: var(--careka-primary); text-decoration: none;">${a.texto}</a></div>`).join('') || 'Nenhum anexo';
      el('trello-historico').innerHTML = (lead.historico || []).map(h => `<div style="margin-bottom: 6px;"><strong>${formatData(h.data)}</strong>: ${h.acao}</div>`).join('') || 'Nenhuma alteração';

      el('trello-title').textContent = lead.nome;
      el('trello-backdrop').classList.remove('hidden');
      el('trello-panel').classList.remove('hidden');
    }

    function closeTrello() {
      el('trello-backdrop').classList.add('hidden');
      el('trello-panel').classList.add('hidden');
    }

    function saveTrello() {
      const lead = state.leads.find(l => l.id === currentLeadId);
      if (!lead) return;
      
      lead.nome = el('trello-nome').value;
      lead.estagio = el('trello-estagio').value;
      lead.prioridade = el('trello-prioridade').value;
      lead.empresa = el('trello-empresa').value;
      lead.cargo = el('trello-cargo').value;
      lead.email = el('trello-email').value;
      lead.telefone = el('trello-telefone').value;
      lead.segmento = el('trello-segmento').value;
      lead.valor = Number(el('trello-valor').value) || 0;
      lead.score = Number(el('trello-score').value) || 0;
      lead.origem = el('trello-origem').value;
      lead.canal = el('trello-canal').value;
      lead.descricao = el('trello-descricao').value;
      
      const proximo = el('trello-proximo').value;
      if (proximo) lead.proximoContato = new Date(proximo).toISOString();

      lead.ultimoContato = nowISO();
      saveState();
      renderAll();
      closeTrello();
      showToast('Lead atualizado!');
    }

    function addAtividade() {
      const lead = state.leads.find(l => l.id === currentLeadId);
      if (!lead) return;
      const texto = el('trello-nova-atividade').value.trim();
      if (!texto) return;
      if (!lead.atividades) lead.atividades = [];
      lead.atividades.push({id: uuid(), texto: texto, data: nowISO()});
      el('trello-nova-atividade').value = '';
      saveState();
      openTrello(currentLeadId);
    }

    function addItemChecklist() {
      const lead = state.leads.find(l => l.id === currentLeadId);
      if (!lead) return;
      const texto = el('trello-novo-item').value.trim();
      if (!texto) return;
      if (!lead.checklist) lead.checklist = [];
      lead.checklist.push({id: uuid(), texto: texto, feito: false});
      el('trello-novo-item').value = '';
      saveState();
      openTrello(currentLeadId);
    }

    function updateChecklistItem(leadId, itemId, feito) {
      const lead = state.leads.find(l => l.id === leadId);
      if (!lead) return;
      const item = (lead.checklist || []).find(i => i.id === itemId);
      if (item) item.feito = feito;
      saveState();
    }

    function addAnexo() {
      const lead = state.leads.find(l => l.id === currentLeadId);
      if (!lead) return;
      const url = el('trello-nova-url').value.trim();
      if (!url) return;
      if (!lead.anexos) lead.anexos = [];
      lead.anexos.push({id: uuid(), url: url, texto: url.split('/').pop() || 'Link'});
      el('trello-nova-url').value = '';
      saveState();
      openTrello(currentLeadId);
    }

    function duplicarLead() {
      const lead = state.leads.find(l => l.id === currentLeadId);
      if (!lead) return;
      const copia = JSON.parse(JSON.stringify(lead));
      copia.id = uuid();
      copia.nome = lead.nome + ' (Cópia)';
      copia.dataCriacao = nowISO();
      copia.historico = [];
      state.leads.push(copia);
      saveState();
      renderAll();
      closeTrello();
      showToast('Lead duplicado!');
    }

    function confirmDeleteLead() {
      if (!confirm('Tem certeza que deseja EXCLUIR este lead permanentemente?')) {
        return;
      }
      
      console.log('Excluindo lead:', currentLeadId);
      
      state.leads = state.leads.filter(l => l.id !== currentLeadId);
      
      saveState();
      
      closeTrello();
      
      renderAll();
      
      console.log('Leads restantes:', state.leads.length);
      
      showToast('Lead excluído com sucesso!');
    }

    function renderAll() {
      updateKPIs();
      updateCharts();
      const activePage = document.querySelector('.sidebar-menu li.active')?.dataset.page;
      if (activePage === 'crm') {
        renderCRM();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeState();
      renderDashboard();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeTrello();
        el('modal-novo').close();
        el('modal-novo-stage').close();
        el('modal-reset').close();
        el('modal-importar').close();
      }
    });
  </script>
</body>
</html>
