path: index.html
<!DOCTYPE html>
<html lang="pt-BR" data-theme="careka-light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CAREKA HUB v4.2.1</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: {
            'careka-dark': '#0B1220',
            'careka-card-dark': '#0F172A',
            'careka-light': '#F7F7F5',
            'careka-primary-light': '#0F766E',
            'careka-primary-dark': '#2DD4BF'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; }
    body { font-family: 'Inter', sans-serif; min-height: 100vh; }
    [data-theme='careka-dark'] { background: #0B1220; color: #fff; }
    [data-theme='careka-dark'] .card, [data-theme='careka-dark'] dialog, [data-theme='careka-dark'] .sidebar {
      background: #0F172A !important;
      color: #fff !important;
    }
    [data-theme='careka-light'] { background: #F7F7F5; color: #111; }
    [data-theme='careka-light'] .card, [data-theme='careka-light'] dialog, [data-theme='careka-light'] .sidebar {
      background: #fff !important;
      color: #222 !important;
    }
    .card { border-radius: 1rem; box-shadow: 0 2px 12px 0 rgba(0,0,0,.04); }
    .kanban-list { min-width: 300px; width: 100%; }
    .kanban-list .sortable-ghost { opacity: 0.3 }
    dialog::backdrop { background: rgba(0, 0, 0, 0.4); }
    .sidebar { min-width: 200px; width: 220px; }
    .active { font-weight: 700; color: #0F766E; }
    ::selection { background: #0F766E33; }
    .input-duplo input { width: 40%; }
  </style>
</head>
<body class="w-screen min-h-screen flex">
  <!-- Sidebar -->
  <aside class="sidebar fixed left-0 top-0 h-full z-10 flex flex-col py-8 px-6 card border-r border-gray-200 shadow-md transition-all duration-300">
    <h1 class="text-2xl font-bold mb-8 tracking-tight select-none" style="letter-spacing:-.5px;">CAREKA HUB</h1>
    <ul class="flex-1 flex flex-col gap-3 text-base text-gray-700 font-medium">
      <li class="active">Dashboard</li>
      <li class="text-gray-400 select-none">v4.2.1</li>
    </ul>
    <div class="mt-auto text-xs text-gray-400 select-none">© 2025 Careka Digital</div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-[220px] py-8 px-8 w-0 transition-all duration-300">
    <!-- Top Controls -->
    <div class="flex items-center justify-between gap-2 mb-6 flex-wrap">
      <div class="flex gap-2 flex-wrap">
        <button id="btn-novo-lead" class="bg-careka-primary-light text-white px-4 py-2 rounded font-medium hover:bg-teal-700 transition" type="button">+ Novo Lead</button>
        <button id="btn-import-csv" class="bg-gray-200 dark:bg-careka-card-dark text-gray-800 dark:text-white px-4 py-2 rounded font-medium hover:bg-gray-300 dark:hover:bg-careka-dark transition" type="button">Importar CSV</button>
        <button id="btn-rodada-diaria" class="bg-blue-50 dark:bg-blue-950 text-careka-primary-light dark:text-careka-primary-dark px-4 py-2 rounded font-medium border border-blue-100 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900 transition" type="button">Rodada Diária</button>
        <button id="btn-reset" class="bg-red-50 dark:bg-red-800 text-red-700 dark:text-red-200 px-4 py-2 rounded font-medium border border-red-200 dark:border-red-700 hover:bg-red-100 dark:hover:bg-red-700 transition" type="button">HARD RESET LEADS</button>
        <button id="btn-theme" class="bg-gray-100 dark:bg-careka-card-dark text-gray-800 dark:text-white px-4 py-2 rounded font-medium hover:bg-gray-200 dark:hover:bg-careka-dark transition" type="button">Tema</button>
      </div>
      <div>
        <button id="btn-backup" class="bg-cyan-50 dark:bg-careka-card-dark text-careka-primary-light dark:text-careka-primary-dark px-4 py-2 rounded font-medium border border-cyan-200 dark:border-careka-primary-dark hover:bg-cyan-100 dark:hover:bg-careka-dark transition" type="button">Backup/Export</button>
        <button id="btn-test-pers" class="ml-2 bg-gray-50 dark:bg-careka-card-dark text-gray-500 dark:text-white border border-gray-200 dark:border-gray-700 px-3 py-2 rounded font-medium hover:bg-gray-100 dark:hover:bg-careka-dark transition" type="button">Teste Persistência</button>
      </div>
    </div>
    <!-- Métricas Cards -->
    <div class="mb-8 grid grid-cols-2 sm:grid-cols-4 gap-4 select-none">
      <div class="card flex flex-col p-5">
        <span class="text-sm text-gray-400">TOTAL LEADS</span>
        <span id="metric-leads" class="text-2xl font-bold mt-1">0</span>
      </div>
      <div class="card flex flex-col p-5">
        <span class="text-sm text-gray-400">R$ VALOR PIPELINE</span>
        <span id="metric-valor" class="text-2xl font-bold mt-1">0</span>
      </div>
      <div class="card flex flex-col p-5">
        <span class="text-sm text-gray-400">TAXA CONVERSÃO</span>
        <span id="metric-conv" class="text-2xl font-bold mt-1">0%</span>
      </div>
      <div class="card flex flex-col p-5">
        <span class="text-sm text-gray-400">ALTA PRIORIDADE</span>
        <span id="metric-alta" class="text-2xl font-bold mt-1">0</span>
      </div>
    </div>
    <!-- Kanban Pipeline -->
    <div id="pipeline" class="flex gap-6 w-full overflow-x-auto pb-8">
      <!-- Colunas inseridas por JS -->
    </div>
  </main>

  <!-- Dialogs -->
  <dialog id="dlg-lead" class="card p-0 w-[90vw] max-w-lg mx-auto mt-12">
    <form method="dialog" class="p-6 flex flex-col gap-4" id="form-lead">
      <h2 class="text-xl font-bold mb-2">Novo Lead</h2>
        <label class="flex flex-col mb-2">
          <span class="mb-1 text-sm font-medium">Nome</span>
          <input type="text" name="nome" required class="rounded border py-2 px-3 bg-gray-50" />
        </label>
        <label class="flex flex-col mb-2">
          <span class="mb-1 text-sm font-medium">Segmento</span>
          <input type="text" name="segmento" required class="rounded border py-2 px-3 bg-gray-50" />
        </label>
        <div class="flex gap-2 input-duplo">
          <label class="flex flex-col mb-2 flex-1">
            <span class="mb-1 text-sm font-medium">Valor (R$)</span>
            <input type="number" min="0" step="100" name="valor" required class="rounded border py-2 px-3 bg-gray-50" />
          </label>
          <label class="flex flex-col mb-2 flex-1">
            <span class="mb-1 text-sm font-medium">Score</span>
            <input type="number" min="0" max="100" name="score" value="60" required class="rounded border py-2 px-3 bg-gray-50" />
          </label>
        </div>
        <div class="flex gap-2 input-duplo">
          <label class="flex flex-col mb-2 flex-1">
            <span class="mb-1 text-sm font-medium">Prioridade</span>
            <select name="prioridade" class="rounded border py-2 px-3 bg-gray-50">
              <option>Média</option>
              <option>Alta</option>
              <option>Baixa</option>
            </select>
          </label>
          <label class="flex flex-col mb-2 flex-1">
            <span class="mb-1 text-sm font-medium">Estágio</span>
            <select name="estagio" class="rounded border py-2 px-3 bg-gray-50">
              <option>Novo</option>
              <option>Qualificar</option>
              <option>Diagnóstico</option>
              <option>Proposta</option>
              <option>Ganho</option>
            </select>
          </label>
        </div>
      <div class="flex gap-2 items-center mt-4">
        <button class="bg-careka-primary-light text-white px-4 py-2 rounded font-medium hover:bg-teal-700 transition" type="submit">Salvar</button>
        <button class="ml-2 text-gray-400 px-4 py-2" type="button" onclick="dlgLead.close()">Cancelar</button>
      </div>
    </form>
  </dialog>
  <dialog id="dlg-import" class="card p-0 w-[90vw] max-w-lg mx-auto mt-12">
    <form method="dialog" class="p-6 flex flex-col gap-4" id="form-import">
      <h2 class="text-xl font-bold mb-2">Importar CSV</h2>
      <input type="file" accept=".csv" id="input-csv" class="mb-2"/>
      <div id="preview-csv" class="text-xs max-h-28 overflow-auto font-mono bg-gray-50 p-2 rounded border border-gray-200 hidden"></div>
      <div class="flex gap-2 items-center mt-4">
        <button id="btn-importar-preview" class="bg-careka-primary-light text-white px-4 py-2 rounded font-medium hover:bg-teal-700 transition" type="button" disabled>Importar</button>
        <button class="ml-2 text-gray-400 px-4 py-2" type="button" onclick="dlgImport.close()">Cancelar</button>
      </div>
    </form>
  </dialog>
  <dialog id="dlg-backup" class="card p-0 w-[90vw] max-w-lg mx-auto mt-12">
    <form method="dialog" class="p-6 flex flex-col gap-4">
      <h2 class="text-xl font-bold mb-2">Backup & Export</h2>
      <div class="flex gap-2 mb-2">
        <button id="btn-exp-csv" class="bg-careka-primary-light text-white px-4 py-2 rounded font-medium hover:bg-teal-700 transition" type="button">Exportar CSV</button>
        <button id="btn-exp-xlsx" class="bg-blue-500 text-white px-4 py-2 rounded font-medium hover:bg-blue-700 transition" type="button">Exportar XLSX</button>
        <button id="btn-exp-json" class="bg-cyan-500 text-white px-4 py-2 rounded font-medium hover:bg-cyan-700 transition" type="button">Salvar JSON</button>
      </div>
      <label class="mt-2 block">
        Restauro: <input type="file" id="input-json-backup" accept=".json" class="my-2"/>
      </label>
      <button class="text-gray-400 px-4 py-2 mt-2" type="button" onclick="dlgBackup.close()">Fechar</button>
    </form>
  </dialog>
  <dialog id="dlg-reset" class="card p-0 w-[90vw] max-w-sm mx-auto mt-12">
    <form method="dialog" class="p-6 flex flex-col gap-4" id="form-reset">
      <h2 class="text-xl font-bold mb-2 text-red-600">HARD RESET!</h2>
      <p class="text-sm">Digite <b>RESET</b> para apagar todos os leads. <br>Esta ação é irreversível!</p>
      <input type="text" id="confirm-reset" maxlength="6" class="rounded border py-2 px-3 bg-gray-50"/>
      <button id="btn-confirm-reset" disabled type="submit" class="bg-red-500 text-white px-4 py-2 rounded font-medium hover:bg-red-700 transition">RESET</button>
      <button class="text-gray-400 px-4 py-2 mt-2" type="button" onclick="dlgReset.close()">Cancelar</button>
    </form>
  </dialog>
  <dialog id="dlg-teste" class="card p-0 w-[90vw] max-w-lg mx-auto mt-12">
    <form method="dialog" class="p-6 flex flex-col gap-4">
      <h2 class="text-xl font-bold mb-2">Teste Persistência</h2>
      <div>
        <span class="font-medium">Tamanho do estado:</span>
        <span id="tamanho-local" class="ml-2 text-blue-600 font-mono"></span>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="btn-salvar" class="bg-careka-primary-light text-white px-4 py-2 rounded font-medium hover:bg-teal-700 transition" type="button">Salvar Estado</button>
        <button id="btn-restaurar" class="bg-blue-500 text-white px-4 py-2 rounded font-medium hover:bg-blue-700 transition" type="button">Restaurar Estado</button>
      </div>
      <button class="text-gray-400 px-4 py-2 mt-2" type="button" onclick="dlgTeste.close()">Fechar</button>
    </form>
  </dialog>

  <input type="file" id="input-hidden-xlsx" class="hidden" accept=".xlsx,.xls" />

  <script>
  // Constantes e Utilitários
  const STAGE_LIST = ['Novo','Qualificar','Diagnóstico','Proposta','Ganho'];
  const STATE_KEY = "careka-hub";
  const THEME_KEY = "careka-theme";
  const STORAGE_TEST = "careka-test-state";
  const METRIC = {
    leads: el('metric-leads'),
    valor: el('metric-valor'),
    conv: el('metric-conv'),
    alta: el('metric-alta')
  };

  function el(id) { return document.getElementById(id) }
  function dlg(id) { return document.getElementById('dlg-' + id) }
  function sum(arr, fn) { return arr.reduce((a,b) => a + (fn(b)||0), 0); }
  function toReal(v) { return "R$ " + Number(v || 0).toLocaleString('pt-BR'); }
  function loadState() {
    try { return JSON.parse(localStorage.getItem(STATE_KEY)) || {leads: []} } catch { return {leads: []}; }
  }
  function saveState(state) {
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }
  function saveTheme(theme) {
    localStorage.setItem(THEME_KEY, theme);
  }
  function getTheme() {
    return localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'careka-dark' : 'careka-light')
  }
  function persistTestSet() {
    localStorage.setItem(STORAGE_TEST, localStorage.getItem(STATE_KEY));
  }
  function persistTestGet() {
    let v = localStorage.getItem(STORAGE_TEST); if (v) localStorage.setItem(STATE_KEY, v);
  }
  function uuid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function nowISO() {
    return new Date().toISOString();
  }
  // Dados Iniciais (Seed)
  const LEAD_SEED = [
    {nome:"Dr. Martinez Odontologia",segmento:"Clínica Odontológica",score:78,valor:15000,estagio:"Novo",prioridade:"Alta",dt:nowISO(),id:uuid()},
    {nome:"Restaurante Sabor",segmento:"Restaurante",score:61,valor:9000,estagio:"Novo",prioridade:"Média",dt:nowISO(),id:uuid()},
    {nome:"Dr. Santos Ortodontia",segmento:"Clínica Odontológica",score:73,valor:16000,estagio:"Novo",prioridade:"Média",dt:nowISO(),id:uuid()},
    {nome:"Academia FitMax",segmento:"Academia",score:68,valor:8000,estagio:"Qualificar",prioridade:"Média",dt:nowISO(),id:uuid()},
    {nome:"Sorriso Brilhante",segmento:"Clínica Odontológica",score:71,valor:12000,estagio:"Qualificar",prioridade:"Alta",dt:nowISO(),id:uuid()},
    {nome:"Studio Slim",segmento:"Estética",score:65,valor:7000,estagio:"Qualificar",prioridade:"Baixa",dt:nowISO(),id:uuid()},
    {nome:"Pet Care Vet",segmento:"Clínica Veterinária",score:72,valor:12000,estagio:"Diagnóstico",prioridade:"Alta",dt:nowISO(),id:uuid()},
    {nome:"Dr. Oliveira Implantes",segmento:"Clínica Odontológica",score:68,valor:22000,estagio:"Diagnóstico",prioridade:"Alta",dt:nowISO(),id:uuid()},
    {nome:"Cross Iron",segmento:"Academia",score:66,valor:6000,estagio:"Proposta",prioridade:"Média",dt:nowISO(),id:uuid()},
    {nome:"Consult Vida",segmento:"Consultoria Médica",score:70,valor:18000,estagio:"Proposta",prioridade:"Alta",dt:nowISO(),id:uuid()},
    {nome:"Tech Phone",segmento:"Loja de Eletrônicos",score:62,valor:9000,estagio:"Novo",prioridade:"Média",dt:nowISO(),id:uuid()},
    {nome:"Clínica Alpha",segmento:"Clínica Odontológica",score:76,valor:14000,estagio:"Novo",prioridade:"Alta",dt:nowISO(),id:uuid()}
  ];

  // Estado
  let state = loadState();
  if (!state.leads || !Array.isArray(state.leads) || state.leads.length < 1) {
    state = {leads: JSON.parse(JSON.stringify(LEAD_SEED))};
    saveState(state);
  }

  // Renderização
  function renderMetrics() {
    METRIC.leads.textContent = state.leads.length;
    METRIC.valor.textContent = toReal(sum(state.leads, l => l.valor));
    // Conversão = Ganho/total
    const ganhos = state.leads.filter(l => l.estagio === 'Ganho').length;
    METRIC.conv.textContent = state.leads.length ? ((ganhos/state.leads.length*100).toFixed(1).replace('.0','')) + "%" : "0%";
    METRIC.alta.textContent = state.leads.filter(l => l.prioridade === 'Alta').length;
  }
  function renderPipeline() {
    const wrap = document.getElementById("pipeline"); wrap.innerHTML = "";
    STAGE_LIST.forEach(stage => {
      const leads = state.leads.filter(l => l.estagio === stage);
      let html = `<div class="kanban-list flex flex-col bg-gray-50 dark:bg-careka-card-dark card p-4 min-w-[260px] max-w-[320px] transition-all">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold tracking-tight text-lg">${stage}</span>
          <span class="bg-careka-primary-light dark:bg-careka-primary-dark text-white rounded-full px-3 py-1 text-xs ml-2">${leads.length}</span>
        </div>
        <div class="flex-1 flex flex-col gap-2" id="pl-${stage}">`;
      leads.forEach(l => {
        html += `
        <div class="card p-3 my-1 flex flex-col cursor-grab" data-id="${l.id}">
          <div class="flex justify-between items-center">
            <span class="font-medium text-base truncate">${l.nome}</span>
            <span class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 ml-1">${l.score}</span>
          </div>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-gray-400 truncate">${l.segmento}</span>
            <span class="text-xs font-bold text-cyan-600 dark:text-cyan-400 ml-1">${toReal(l.valor)}</span>
          </div>
          <div class="flex justify-between items-center mt-2 text-xs">
            <span class="rounded px-2 py-0.5 ${badgeColor(l.prioridade)}">${l.prioridade}</span>
            <span class="text-gray-300">${(new Date(l.dt)).toLocaleDateString("pt-BR")}</span>
          </div>
        </div>`;
      });
      html += '</div></div>';
      wrap.innerHTML += html;
    });

    // Drag & Drop por coluna
    STAGE_LIST.forEach(stage => {
      new Sortable(document.getElementById("pl-"+stage), {
        group: 'pipeline',
        animation: 160,
        onEnd: handleDragMove
      });
    });
  }
  function badgeColor(p) {
    if (p === 'Alta') return "bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-200";
    if (p === 'Média') return "bg-yellow-100 text-yellow-600 dark:bg-yellow-950 dark:text-yellow-100";
    return "bg-green-100 text-green-700 dark:bg-green-800 dark:text-green-200";
  }

  function renderAll() {
    renderMetrics();
    renderPipeline();
    updateTheme();
  }

  // Funções de Leads
  function addLead(ld) {
    ld.id = uuid(); ld.dt = nowISO();
    state.leads.unshift(ld);
    saveState(state);
    renderAll();
  }

  // Drag & Drop para mudar estágio
  function handleDragMove(evt) {
    let id = evt.item.dataset.id;
    let newStage = evt.to.id.replace('pl-', '');
    let lead = state.leads.find(l => l.id === id);
    if (lead) {
      lead.estagio = newStage;
      saveState(state);
      renderAll();
    }
  }

  // --- Nova Lead
  el('btn-novo-lead').onclick = () => {
    dlgLead.showModal();
    let f = dlgLead.querySelector('form');
    f.reset();
    f.score.value = 60; f.prioridade.value = "Média"; f.estagio.value = "Novo";
  };
  dlgLead = dlg('lead');
  dlgLead.querySelector('form').onsubmit = function(ev) {
    ev.preventDefault();
    let fd = new FormData(this);
    addLead({
        nome:fd.get('nome'),
        segmento:fd.get('segmento'),
        valor:Number(fd.get('valor')),
        score:Number(fd.get('score')),
        prioridade:fd.get('prioridade'),
        estagio:fd.get('estagio')
    });
    dlgLead.close();
    return false;
  }

  // --- Import CSV
  el('btn-import-csv').onclick = () => {
    dlgImport.showModal();
    el('input-csv').value = "";
    el('preview-csv').classList.add('hidden');
    el('btn-importar-preview').disabled = true;
    previewCSVRows = [];
  }
  dlgImport = dlg('import');
  let previewCSVRows = [];
  el('input-csv').onchange = function(ev) {
    if (!this.files[0]) return;
    Papa.parse(this.files[0], {
      header:true,
      skipEmptyLines:true,
      complete: function(res) {
        let rows = res.data.filter(r=>r.nome && r.valor && r.estagio);
        if (!rows.length) { el('preview-csv').innerHTML="Erro: Nenhuma linha válida!"; return; }
        previewCSVRows = rows;
        let prev = rows.slice(0,6).map(r=>JSON.stringify(r)).join("<br>");
        el('preview-csv').innerHTML = prev + (rows.length>6?"<br>...":"");
        el('preview-csv').classList.remove('hidden');
        el('btn-importar-preview').disabled = false;
      }
    })
  }
  el('btn-importar-preview').onclick = function() {
    previewCSVRows.forEach(r => {
      addLead({
        nome: r.nome, segmento: r.segmento, valor:Number(r.valor),
        score: Number(r.score||'60'), prioridade:r.prioridade||'Média',
        estagio: r.estagio||'Novo'
      });
    });
    dlgImport.close();
  }

  // --- Exportações (CSV, XLSX, JSON)
  el('btn-backup').onclick = ()=> dlgBackup.showModal();
  dlgBackup = dlg('backup');
  el('btn-exp-csv').onclick = ()=> exportCSV();
  el('btn-exp-xlsx').onclick = ()=> exportXLSX();
  el('btn-exp-json').onclick = ()=> exportJSON();

  function exportCSV() {
    const rows = state.leads.map(l=>({
      nome:l.nome,segmento:l.segmento,valor:l.valor,score:l.score,
      prioridade:l.prioridade,estagio:l.estagio,dt:l.dt
    }));
    let csv = Papa.unparse(rows);
    let blob = new Blob([csv],{type:"text/csv"});
    downloadBlob(blob, 'careka-leads.csv');
  }
  function exportXLSX() {
    const ws = XLSX.utils.json_to_sheet(state.leads.map(l=>({
      nome:l.nome,segmento:l.segmento,valor:l.valor,score:l.score,
      prioridade:l.prioridade,estagio:l.estagio,dt:l.dt
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Leads");
    let wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    let blob = new Blob([wbout], {type:"application/octet-stream"});
    downloadBlob(blob,'careka-leads.xlsx');
  }
  function exportJSON() {
    let blob = new Blob([JSON.stringify(state)], {type:"application/json"});
    downloadBlob(blob, "careka-hub-backup.json");
  }
  function downloadBlob(blob, filename) {
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }
  el('input-json-backup').onchange = function(ev) {
    let f = this.files[0];
    if (!f) return;
    let fr = new FileReader();
    fr.onload = function() {
      try {
        let newState = JSON.parse(fr.result);
        if (!Array.isArray(newState.leads)) throw "";
        state = newState;
        saveState(state);
        renderAll();
        alert('Backup restaurado.');
      } catch { alert('Arquivo inválido.'); }
    }
    fr.readAsText(f);
    this.value="";
    dlgBackup.close();
  }

  // --- Rodada Diária
  el('btn-rodada-diaria').onclick = () => {
    let mudanca = false, agora = Date.now();
    state.leads.forEach(l => {
      let last = new Date(l.dt).getTime();
      if ((agora - last) / (3600 * 1000) > 48) {
        l.score = Number(l.score||60) + 2;
        l.dt = nowISO(); mudanca = true;
      }
      if (l.score >= 80 && l.valor > 10000 && l.estagio!=='Proposta' && l.estagio!=='Ganho') {
        l.estagio = 'Proposta'; mudanca = true;
      }
      if (l.score > 100) l.score = 100; // trava
    });
    if (mudanca) {
      saveState(state); renderAll();
      alert('Rodada aplicada');
    } else alert('Sem alterações!');
  };

  // --- HARD RESET
  el('btn-reset').onclick = ()=>{ dlgReset.showModal(); el('confirm-reset').value=""; el('btn-confirm-reset').disabled=true;}
  dlgReset = dlg('reset');
  el('confirm-reset').oninput = function() {
    el('btn-confirm-reset').disabled = this.value !== "RESET";
  }
  el('form-reset').onsubmit = function(e) {
    e.preventDefault();
    state = {leads: []};
    saveState(state);
    renderAll();
    dlgReset.close();
    alert('Todos os leads foram apagados!');
    return false;
  }

  // --- Tema (claro/escuro)
  el('btn-theme').onclick = () => {
    document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'careka-light' ? 'careka-dark' : 'careka-light' );
    saveTheme(document.documentElement.getAttribute('data-theme'));
    updateTheme();
  };
  function updateTheme() {
    let t = getTheme();
    document.documentElement.setAttribute('data-theme', t);
  }
  updateTheme();

  // --- Teste Persistência
  el('btn-test-pers').onclick = ()=> {
    dlgTeste.showModal();
    el('tamanho-local').textContent = (localStorage.getItem(STATE_KEY)||"").length + " bytes";
  }
  dlgTeste = dlg('teste');
  el('btn-salvar').onclick = ()=> {
    persistTestSet(); alert('Estado salvo no slot de teste.');
  }
  el('btn-restaurar').onclick = ()=> {
    persistTestGet(); state = loadState(); renderAll(); alert('Restaurado do slot teste.');
  }

  // Inicialização
  document.addEventListener("DOMContentLoaded",()=>{ renderAll(); });
  </script>
</body>
</html>
